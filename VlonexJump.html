<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foxulous: Attack of the Clones</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }

        #gameCanvas {
            display: block;
        }

        /* UI –°–ª–µ–≤–∞ (–û—á–∫–∏) */
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
        }

        /* UI –°–ø—Ä–∞–≤–∞ (–†–µ–π—Ç–∏–Ω–≥) */
        #leaderboard {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 10;
        }

        #leaderboard h3 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 16px;
            color: orange;
        }

        .lb-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .lb-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
        .lb-score { font-weight: bold; }

        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joystick-zone {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5;
        }

        .joystick-base {
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }

        .joystick-stick {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 165, 0, 0.6);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 10px orange;
        }
        
        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: orange;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            text-align: center;
            transition: opacity 0.5s;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 20;
        }
    </style>
</head>
<body>

<div id="ui">
    <h2 style="margin:0; font-size: 18px;">Foxulous</h2>
    <p style="margin:5px 0 0 0;">–ú–∞—Å—Å–∞: <span id="scoreVal">0</span></p>
    <p style="margin:5px 0 0 0; font-size: 12px; color: #aaa;" id="apiStatus">...</p>
</div>

<div id="leaderboard">
    <h3>–ü–∏—â–µ–≤–∞—è —Ü–µ–ø—å</h3>
    <div id="lb-content"></div>
</div>

<div id="loading">–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å –ª–∏—Å–∞–º–∏... <br><span id="timerVal">5.0</span>s</div>

<!-- –î–∂–æ–π—Å—Ç–∏–∫ -->
<div id="joystick-zone"></div>
<div id="j-base" class="joystick-base">
    <div id="j-stick" class="joystick-stick"></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/**
 * FOXULOUS v2.0: Clone Wars Edition
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const uiScore = document.getElementById('scoreVal');
const uiStatus = document.getElementById('apiStatus');
const lbContent = document.getElementById('lb-content');
const loadingBox = document.getElementById('loading');
const timerSpan = document.getElementById('timerVal');

// --- –°–ü–ò–°–û–ö –ò–ú–ï–ù (–ó–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω–¥) ---
const BOT_NAMES = [
    "–í–ª–æ–Ω–µ–∫—Ñ", "KitKat", "Knopkodav", "Dawa‚Å¥¬≤ (—Å—Ç—É–ª)", "–ë–æ–≥–∏–Ω—è –Ω–æ—Ä–º–∏ZOV",
    "WDWNN", "–Ü–≤–∞–Ω üòπü•Ä", "–û–ª—î—Ñ–æ–∫—Å—î", "–ë–µ—Ç–æ–Ω", "–ö—Ä—ã—Å",
    "–≠–¥—É–∞—Ä–¥ –ö–∏—á–∏–≥–∏–Ω", "–£–≤–∞–∂–∞–µ–º—ã–π(-–∞—è)", ", , –ú –æ —Å —Å –∞ –¥ , ,", ",,–ú–æ—Å—Å–∞—Å,,"
];

// --- –ö–û–ù–§–ò–ì ---
const WORLD_SIZE = 4000;
const INITIAL_PLAYER_RADIUS = 40;
const FOOD_COUNT = 150; // –ë–æ–ª—å—à–µ –º—è—Å–∞
const FALLBACK_EMOJIS = ['ü¶ä', 'ü¶Å', 'üêØ', 'üê∫', 'ü¶ù', 'üêÆ', 'üê∑', 'üêπ', 'üê∏', 'üêî', 'ü¶Ñ', 'üêó'];
const API_TIMEOUT_SEC = 5;

// --- –°–û–°–¢–û–Ø–ù–ò–ï ---
let player = {
    id: 'player',
    name: "–í–´ (–ì–µ—Ä–æ–π)",
    x: WORLD_SIZE / 2,
    y: WORLD_SIZE / 2,
    radius: INITIAL_PLAYER_RADIUS,
    score: 0,
    speed: 5,
    skin: null // Image –∏–ª–∏ Emoji
};

let foods = []; // –≠—Ç–æ —Ç–µ–ø–µ—Ä—å –∏ "–±–æ—Ç—ã", –∏ –µ–¥–∞
let camera = { x: 0, y: 0 };
let useApi = true;
let keys = {};
let joystick = { active: false, startX: 0, startY: 0, dx: 0, dy: 0 };

// --- –ó–ê–ì–†–£–ó–ö–ê ---

async function fetchFoxImageWithTimeout(timeoutMs) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
        const response = await fetch('https://api.tinyfox.dev/img.json?animal=fox', { signal: controller.signal });
        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        const imgUrl = 'https://tinyfox.dev' + data.loc;
        
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => resolve(img);
            img.onerror = () => reject('Img Load Error');
            img.src = imgUrl;
        });
    } catch (error) {
        return null; 
    } finally {
        clearTimeout(timeoutId);
    }
}

// –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
function startTimer(seconds) {
    let left = seconds;
    timerSpan.innerText = left.toFixed(1);
    
    return new Promise((resolve) => {
        const interval = setInterval(() => {
            left -= 0.1;
            if(left < 0) left = 0;
            timerSpan.innerText = left.toFixed(1);
            
            if (left <= 0) {
                clearInterval(interval);
                resolve(false); // –í—Ä–µ–º—è –≤—ã—à–ª–æ
            }
        }, 100);

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–æ–±—É–µ–º –≥—Ä—É–∑–∏—Ç—å
        fetchFoxImageWithTimeout(seconds * 1000).then(img => {
            if (img) {
                clearInterval(interval);
                resolve(img); // –£—Å–ø–µ—Ö —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
            }
        });
    });
}

async function initGameAssets() {
    const result = await startTimer(API_TIMEOUT_SEC);

    if (result && result instanceof Image) {
        player.skin = result;
        useApi = true;
        uiStatus.innerText = "API: –†–∞–±–æ—Ç–∞–µ—Ç (–õ–∏—Å—ã)";
        uiStatus.style.color = "#4f4";
    } else {
        useApi = false;
        player.skin = 'ü¶ä';
        uiStatus.innerText = "API: –û—Ç–≤–∞–ª–∏–ª—Å—è (–≠–º–æ–¥–∑–∏)";
        uiStatus.style.color = "#f44";
    }

    loadingBox.style.display = 'none';
    spawnFood(FOOD_COUNT);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Ä–∞–∑ –≤ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ü
    setInterval(updateLeaderboard, 500);
    
    gameLoop();
}

// --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ò–†–ê ---
function spawnFood(count) {
    for (let i = 0; i < count; i++) {
        const isBigBot = Math.random() > 0.8; // 20% —à–∞–Ω—Å –Ω–∞ "–∂–∏—Ä–Ω–æ–≥–æ" –±–æ—Ç–∞
        const radius = isBigBot ? 20 + Math.random() * 30 : 10 + Math.random() * 10;
        
        foods.push({
            id: `bot_${Math.random()}`,
            name: getRandomName(),
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            radius: radius,
            skin: useApi && Math.random() > 0.6 ? 'loading' : getRandomEmoji(),
            color: `hsl(${Math.random() * 360}, 60%, 50%)`,
            vx: (Math.random() - 0.5) * 2, // –ë–æ—Ç—ã —á—É—Ç—å-—á—É—Ç—å –¥—Ä–µ–π—Ñ—É—é—Ç
            vy: (Math.random() - 0.5) * 2
        });
    }

    if (useApi) {
        // –§–æ–Ω–æ–≤–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–ª—è –±–æ—Ç–æ–≤
        foods.filter(f => f.skin === 'loading').forEach(f => {
            fetchFoxImageWithTimeout(10000).then(img => {
                f.skin = img || getRandomEmoji();
            });
        });
    }
}

function getRandomEmoji() {
    return FALLBACK_EMOJIS[Math.floor(Math.random() * FALLBACK_EMOJIS.length)];
}

function getRandomName() {
    return BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)];
}

// --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
function update() {
    // 1. –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    let dx = 0, dy = 0;
    if (keys['ArrowUp'] || keys['KeyW']) dy = -1;
    if (keys['ArrowDown'] || keys['KeyS']) dy = 1;
    if (keys['ArrowLeft'] || keys['KeyA']) dx = -1;
    if (keys['ArrowRight'] || keys['KeyD']) dx = 1;
    
    if (joystick.active) { dx = joystick.dx; dy = joystick.dy; }
    
    if (!joystick.active && (dx !== 0 || dy !== 0)) {
        const len = Math.sqrt(dx*dx + dy*dy);
        dx /= len; dy /= len;
    }

    // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç —Å –º–∞—Å—Å–æ–π (–ª–æ–≥–∏–∫–∞ –ê–≥–∞—Ä–∏–æ)
    const speed = Math.max(1.5, player.speed * Math.pow(INITIAL_PLAYER_RADIUS / player.radius, 0.4));
    
    player.x += dx * speed;
    player.y += dy * speed;
    
    // –°—Ç–µ–Ω—ã
    player.x = clamp(player.x, player.radius, WORLD_SIZE - player.radius);
    player.y = clamp(player.y, player.radius, WORLD_SIZE - player.radius);

    // 2. –î—Ä–µ–π—Ñ –±–æ—Ç–æ–≤ (—á—Ç–æ–±—ã –∂–∏–∑–Ω—å –∫–∏–ø–µ–ª–∞)
    foods.forEach(f => {
        f.x += f.vx;
        f.y += f.vy;
        // –û—Ç—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç —Å—Ç–µ–Ω
        if(f.x < 0 || f.x > WORLD_SIZE) f.vx *= -1;
        if(f.y < 0 || f.y > WORLD_SIZE) f.vy *= -1;
    });

    // 3. –ü–æ–µ–¥–∞–Ω–∏–µ
    for (let i = foods.length - 1; i >= 0; i--) {
        const f = foods[i];
        const dist = Math.hypot(player.x - f.x, player.y - f.y);
        
        if (dist < player.radius - f.radius * 0.3) { // –ù–∞–¥–æ –ø–æ–∫—Ä—ã—Ç—å –±–æ—Ç–∞ —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏—á–Ω–æ
             // –†–æ—Å—Ç –ø–ª–æ—â–∞–¥–∏
             const areaP = Math.PI * player.radius * player.radius;
             const areaF = Math.PI * f.radius * f.radius;
             player.radius = Math.sqrt((areaP + areaF * 0.5) / Math.PI); // 50% –ö–ü–î
             
             player.score += Math.floor(f.radius);
             uiScore.innerText = player.score;
             
             // –†–µ—Å–ø–∞–≤–Ω –µ–¥—ã
             foods.splice(i, 1);
             setTimeout(() => spawnFood(1), 1000); // –°–ø–∞–≤–Ω –Ω–æ–≤–æ–π –∂–µ—Ä—Ç–≤—ã —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        }
    }
}

function updateLeaderboard() {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –≤ –∫—É—á—É, —Å–æ—Ä—Ç–∏—Ä—É–µ–º
    let allEntities = [...foods, player];
    
    // –û—á–∫–∏ = —Ä–∞–¥–∏—É—Å (–≥—Ä—É–±–æ –≥–æ–≤–æ—Ä—è) –∏–ª–∏ score
    allEntities.sort((a, b) => (b.radius) - (a.radius));
    
    // –¢–æ–ø 10
    const top10 = allEntities.slice(0, 10);
    
    let html = '';
    top10.forEach(e => {
        const isMe = e === player;
        const color = isMe ? '#4f4' : 'white';
        const name = e.name || '???';
        const score = Math.floor(e.radius); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–¥–∏—É—Å –∫–∞–∫ —Ç–µ–∫—É—â—É—é "–º–∞—Å—Å—É"
        html += `
            <div class="lb-row" style="color:${color}">
                <span class="lb-name">${name}</span>
                <span class="lb-score">${score}</span>
            </div>`;
    });
    lbContent.innerHTML = html;
}

// --- –û–¢–†–ò–°–û–í–ö–ê ---
function draw() {
    if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    // –§–æ–Ω
    ctx.fillStyle = '#202020';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // –°–µ—Ç–∫–∞
    ctx.strokeStyle = '#303030';
    ctx.lineWidth = 2;
    const gridSize = 100;
    const startX = Math.floor(camera.x / gridSize) * gridSize;
    const startY = Math.floor(camera.y / gridSize) * gridSize;
    
    ctx.beginPath();
    for (let x = startX; x < camera.x + canvas.width; x += gridSize) {
        if(x >= 0 && x <= WORLD_SIZE) { ctx.moveTo(x, Math.max(0, camera.y)); ctx.lineTo(x, Math.min(WORLD_SIZE, camera.y + canvas.height)); }
    }
    for (let y = startY; y < camera.y + canvas.height; y += gridSize) {
        if(y >= 0 && y <= WORLD_SIZE) { ctx.moveTo(Math.max(0, camera.x), y); ctx.lineTo(Math.min(WORLD_SIZE, camera.x + canvas.width), y); }
    }
    ctx.stroke();

    // –ì—Ä–∞–Ω–∏—Ü—ã
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 5;
    ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è Z-index (–º–µ–ª–∫–∏–µ —Å–Ω–∏–∑—É)
    const allToDraw = [...foods, player].sort((a, b) => a.radius - b.radius);
    
    allToDraw.forEach(blob => drawBlob(blob));

    ctx.restore();
}

function drawBlob(blob) {
    // –ö—É–ª–∏–Ω–≥ (–Ω–µ —Ä–∏—Å—É–µ–º –∑–∞ —ç–∫—Ä–∞–Ω–æ–º)
    if (blob.x + blob.radius < camera.x || blob.x - blob.radius > camera.x + canvas.width ||
        blob.y + blob.radius < camera.y || blob.y - blob.radius > camera.y + canvas.height) return;

    ctx.save();
    ctx.translate(blob.x, blob.y);

    // –ú–∞—Å–∫–∞ –∫—Ä—É–≥–∞
    ctx.beginPath();
    ctx.arc(0, 0, blob.radius, 0, Math.PI * 2);
    ctx.closePath();

    // –°–∫–∏–Ω
    if (blob.skin instanceof Image) {
        ctx.save();
        ctx.clip();
        ctx.drawImage(blob.skin, -blob.radius, -blob.radius, blob.radius * 2, blob.radius * 2);
        ctx.restore();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
    } else if (typeof blob.skin === 'string' && blob.skin !== 'loading') {
        ctx.fillStyle = blob.color;
        ctx.fill();
        ctx.font = `${blob.radius * 1.2}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(blob.skin, 0, blob.radius * 0.1);
    } else {
        // –õ–æ–∞–¥–∏–Ω–≥
        ctx.fillStyle = '#444';
        ctx.fill();
        ctx.strokeStyle = '#666';
        ctx.stroke();
    }

    // –ò–ú–Ø (–Ω–∞–¥ —à–∞—Ä–æ–º)
    ctx.shadowColor = 'black';
    ctx.shadowBlur = 3;
    ctx.fillStyle = 'white';
    ctx.font = `bold ${Math.max(10, blob.radius * 0.4)}px sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom'; // –†–∏—Å—É–µ–º –ù–ê–î —Ü–µ–Ω—Ç—Ä–æ–º (–ø–æ—á—Ç–∏ –Ω–∞–¥ —à–∞—Ä–æ–º)
    
    // –°–º–µ—â–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —á—É—Ç—å –≤—ã—à–µ —à–∞—Ä–∞
    const nameOffset = -blob.radius - 5;
    ctx.fillText(blob.name, 0, nameOffset);

    // –û–ß–ö–ò (–≤–Ω—É—Ç—Ä–∏)
    // –ï—Å–ª–∏ —à–∞—Ä –±–æ–ª—å—à–æ–π, —Ä–∏—Å—É–µ–º –º–∞—Å—Å—É –≤–Ω—É—Ç—Ä–∏
    if (blob.radius > 15) {
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.max(8, blob.radius * 0.3)}px sans-serif`;
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.fillText(Math.floor(blob.radius), 0, blob.radius * 0.5); // –ß—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞
    }

    ctx.restore();
}

// –£—Ç–∏–ª–∏—Ç—ã
function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

const joyZone = document.getElementById('joystick-zone');
const joyBase = document.getElementById('j-base');
const joyStick = document.getElementById('j-stick');

joyZone.addEventListener('touchstart', e => {
    e.preventDefault();
    const t = e.changedTouches[0];
    joystick.active = true;
    joystick.startX = t.clientX; joystick.startY = t.clientY;
    
    joyBase.style.display = 'block';
    joyBase.style.left = t.clientX + 'px'; joyBase.style.top = t.clientY + 'px';
    joyStick.style.transform = `translate(-50%, -50%)`;
}, {passive:false});

joyZone.addEventListener('touchmove', e => {
    e.preventDefault();
    if(!joystick.active) return;
    const t = e.changedTouches[0];
    let dx = t.clientX - joystick.startX;
    let dy = t.clientY - joystick.startY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const max = 50;
    
    if(dist > max) { dx = (dx/dist)*max; dy = (dy/dist)*max; }
    
    joyStick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    joystick.dx = dx/max; joystick.dy = dy/max;
}, {passive:false});

joyZone.addEventListener('touchend', e => {
    e.preventDefault();
    joystick.active = false; joystick.dx = 0; joystick.dy = 0;
    joyBase.style.display = 'none';
});

// –°—Ç–∞—Ä—Ç
window.onload = initGameAssets;

</script>
</body>
</html>