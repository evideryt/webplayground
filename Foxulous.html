<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foxulous - –õ–∏—Å–∏–π –ë–µ—Å–ø—Ä–µ–¥–µ–ª</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: white;
            font-weight: bold; text-shadow: 1px 1px 2px black; pointer-events: none;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="ui">Foxulous v0.1 <br> –û—á–∫–∏: <span id="scoreVal">0</span></div>
<div id="loading">–ü—Ä–∏–∑—ã–≤–∞—é –ª–∏—Å...</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–ø–∞–≥–µ—Ç—Ç–∏-–∫–æ–¥.
 * –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Ç–∞–µ—Ç –±–æ–≥ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –ø—Ä–æ—Å—Ç–∏ –º–µ–Ω—è.
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('scoreVal');
const loadingEl = document.getElementById('loading');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏—Ä–∞
const WORLD_SIZE = 4000; // –†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã, —á—Ç–æ–± –±—ã–ª–æ –≥–¥–µ —Ä–∞–∑–≥—É–ª—è—Ç—å—Å—è
const PLAYER_START_RAD = 30;
const BOT_COUNT = 30;
const FOOD_COUNT = 200;

let width, height;
let cameraX = 0, cameraY = 0;
let gameRunning = true;

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞ (–¥–ª—è —ç–ª–∏—Ç—ã –Ω–∞ –ü–ö)
const keys = { w: false, a: false, s: false, d: false };
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞ (–¥–ª—è –ø–∞–ª—å—Ü–µ–≤—ã—Ö —Ç—ã–∫–∞—Ç–µ–ª–µ–π)
const touchInput = { active: false, startX: 0, startY: 0, currX: 0, currY: 0 };

// --- API –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ---
const FALLBACK_EMOJIS = ['ü¶ä', 'üê∫', 'üê∂', 'üå≠', 'ü•ê', 'üí©', 'üò∫'];
const loadedImages = []; // –ö—ç—à –∫–∞—Ä—Ç–∏–Ω–æ–∫, —á—Ç–æ–± –Ω–µ –¥—É–¥–æ—Å–∏—Ç—å API

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±—ã—á–∏ –ª–∏—Å—ã. –ï—Å–ª–∏ API –ª–µ–∂–∏—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null (–±—É–¥–µ—Ç —ç–º–æ–¥–∑–∏)
async function fetchFoxUrl() {
    try {
        // –î–æ–±–∞–≤–ª—è–µ–º timestamp, —á—Ç–æ–± –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–ª JSON
        const res = await fetch(`https://api.tinyfox.dev/img.json?animal=fox&t=${Date.now()}`);
        const data = await res.json();
        return "https://tinyfox.dev" + data.loc;
    } catch (e) {
        // console.log("–õ–∏—Å–∞ —Å–±–µ–∂–∞–ª–∞ (API error):", e);
        return null; // –§–æ–ª–ª–±—ç–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º
    }
}

// –ö–ª–∞—Å—Å —Å—É—â–Ω–æ—Å—Ç–∏ (–ò–≥—Ä–æ–∫ –∏–ª–∏ –ë–æ—Ç)
class Blob {
    constructor(x, y, r, isPlayer = false) {
        this.x = x;
        this.y = y;
        this.r = r;
        this.isPlayer = isPlayer;
        this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
        this.vx = 0;
        this.vy = 0;
        this.speed = 0;
        this.maxSpeed = 5;
        this.image = null;
        this.emoji = FALLBACK_EMOJIS[Math.floor(Math.random() * FALLBACK_EMOJIS.length)];
        this.imgLoaded = false;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏—Å—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–±–∞
        this.loadFox();
    }

    async loadFox() {
        const url = await fetchFoxUrl();
        if (url) {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // –í–∞–∂–Ω–æ –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞
            img.src = url;
            img.onload = () => {
                this.image = img;
                this.imgLoaded = true;
            };
            img.onerror = () => { this.imgLoaded = false; };
        }
    }

    update() {
        // –§–∏–∑–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è (–æ—á–µ–Ω—å –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è, –∫–∞–∫ –º–æ–π —é–º–æ—Ä)
        if (this.isPlayer) {
            let dx = 0, dy = 0;
            
            // –ü–ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (keys.w || keys.ArrowUp) dy -= 1;
            if (keys.s || keys.ArrowDown) dy += 1;
            if (keys.a || keys.ArrowLeft) dx -= 1;
            if (keys.d || keys.ArrowRight) dx += 1;

            // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–∂–æ–π—Å—Ç–∏–∫)
            if (touchInput.active) {
                dx = touchInput.currX - touchInput.startX;
                dy = touchInput.currY - touchInput.startY;
            }

            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∞
            const len = Math.sqrt(dx*dx + dy*dy);
            if (len > 0) {
                // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ (—á–µ–º –∂–∏—Ä–Ω–µ–µ, —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
                const currentMaxSpeed = 100 / (this.r + 20) + 2; 
                this.vx = (dx / len) * currentMaxSpeed;
                this.vy = (dy / len) * currentMaxSpeed;
            } else {
                this.vx *= 0.9; // –¢—Ä–µ–Ω–∏–µ
                this.vy *= 0.9;
            }
        } else {
            // –õ–æ–≥–∏–∫–∞ –±–æ—Ç–æ–≤: —Ä–∞–Ω–¥–æ–º–Ω–æ–µ –±–ª—É–∂–¥–∞–Ω–∏–µ
            if (Math.random() < 0.02) {
                const angle = Math.random() * Math.PI * 2;
                const currentMaxSpeed = 100 / (this.r + 20) + 2;
                this.vx = Math.cos(angle) * currentMaxSpeed;
                this.vy = Math.sin(angle) * currentMaxSpeed;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –¥–ª—è –±–æ—Ç–æ–≤
            if (this.x < 0) this.vx = Math.abs(this.vx);
            if (this.x > WORLD_SIZE) this.vx = -Math.abs(this.vx);
            if (this.y < 0) this.vy = Math.abs(this.vy);
            if (this.y > WORLD_SIZE) this.vy = -Math.abs(this.vy);
        }

        this.x += this.vx;
        this.y += this.vy;

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –º–∏—Ä–∞
        this.x = Math.max(this.r, Math.min(WORLD_SIZE - this.r, this.x));
        this.y = Math.max(this.r, Math.min(WORLD_SIZE - this.r, this.y));
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        
        // –†–∏—Å—É–µ–º –∫—Ä—É–≥-–º–∞—Å–∫—É
        ctx.beginPath();
        ctx.arc(0, 0, this.r, 0, Math.PI * 2);
        ctx.fillStyle = this.color; // –¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // –†–∏—Å—É–µ–º –ª–∏—Å—É –∏–ª–∏ —ç–º–æ–¥–∑–∏
        if (this.imgLoaded && this.image) {
            ctx.clip(); // –û–±—Ä–µ–∑–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ –∫—Ä—É–≥—É
            try {
                ctx.drawImage(this.image, -this.r, -this.r, this.r * 2, this.r * 2);
            } catch (e) {
                // –ï—Å–ª–∏ CORS —Ä–µ—à–∏–ª —É–±–∏—Ç—å –Ω–∞—Å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç
                this.drawEmoji();
            }
        } else {
            this.drawEmoji();
        }

        // –†–∏—Å—É–µ–º –æ—á–∫–∏ (–º–∞—Å—Å—É)
        ctx.restore(); // –°–±—Ä–æ—Å –∫–ª–∏–ø–∞
        ctx.fillStyle = 'white';
        ctx.font = `bold ${Math.max(12, this.r / 2)}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.strokeText(Math.floor(this.r), this.x, this.y);
        ctx.fillText(Math.floor(this.r), this.x, this.y);
    }

    drawEmoji() {
        ctx.font = `${this.r}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.emoji, 0, 0);
    }
}

// –ï–¥–∞
const foods = [];
for(let i=0; i<FOOD_COUNT; i++) spawnFood();

function spawnFood() {
    foods.push({
        x: Math.random() * WORLD_SIZE,
        y: Math.random() * WORLD_SIZE,
        r: 5 + Math.random() * 5,
        color: `hsl(${Math.random()*360}, 100%, 50%)`
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
let player = new Blob(WORLD_SIZE/2, WORLD_SIZE/2, PLAYER_START_RAD, true);
let bots = [];
for(let i=0; i<BOT_COUNT; i++) {
    bots.push(new Blob(Math.random()*WORLD_SIZE, Math.random()*WORLD_SIZE, 20 + Math.random() * 40));
}

// –†–µ—Å–∞–π–∑ —ç–∫—Ä–∞–Ω–∞
function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
}
window.addEventListener('resize', resize);
resize();

// --- –í–≤–æ–¥ ---
window.addEventListener('keydown', e => { keys[e.key] = true; keys[e.code] = true; });
window.addEventListener('keyup', e => { keys[e.key] = false; keys[e.code] = false; });

// –î–∂–æ–π—Å—Ç–∏–∫ –ª–æ–≥–∏–∫–∞
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    touchInput.active = true;
    touchInput.startX = e.touches[0].clientX;
    touchInput.startY = e.touches[0].clientY;
    touchInput.currX = touchInput.startX;
    touchInput.currY = touchInput.startY;
}, {passive: false});

canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (touchInput.active) {
        touchInput.currX = e.touches[0].clientX;
        touchInput.currY = e.touches[0].clientY;
    }
}, {passive: false});

canvas.addEventListener('touchend', e => {
    e.preventDefault();
    touchInput.active = false;
});

// --- –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ---
function loop() {
    if (!gameRunning) return;

    // –û—á–∏—Å—Ç–∫–∞
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, width, height);

    // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
    // Lerp –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ (–Ω—É –ø–æ—á—Ç–∏)
    cameraX = player.x - width / 2;
    cameraY = player.y - height / 2;

    ctx.save();
    ctx.translate(-cameraX, -cameraY);

    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (—á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ –º—ã –¥–≤–∏–∂–µ–º—Å—è)
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    const gridSize = 50;
    const startX = Math.floor(cameraX / gridSize) * gridSize;
    const startY = Math.floor(cameraY / gridSize) * gridSize;
    
    ctx.beginPath();
    for (let x = startX; x < cameraX + width; x += gridSize) {
        ctx.moveTo(x, cameraY);
        ctx.lineTo(x, cameraY + height);
    }
    for (let y = startY; y < cameraY + height; y += gridSize) {
        ctx.moveTo(cameraX, y);
        ctx.lineTo(cameraX + width, y);
    }
    ctx.stroke();

    // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 5;
    ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏ –ª–æ–≥–∏–∫–∞ –µ–¥—ã
    for (let i = foods.length - 1; i >= 0; i--) {
        const f = foods[i];
        
        // –†–∏—Å—É–µ–º
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fillStyle = f.color;
        ctx.fill();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–µ–¥–∞–Ω–∏—è –∏–≥—Ä–æ–∫–æ–º
        const dist = Math.hypot(player.x - f.x, player.y - f.y);
        if (dist < player.r) {
            player.r += 0.5; // –†–∞—Å—Ç–µ–º
            foods.splice(i, 1);
            spawnFood();
        }
    }
    
    // –õ–æ–≥–∏–∫–∞ –±–æ—Ç–æ–≤ (–æ–Ω–∏ —Ç–æ–∂–µ —Ö–æ—Ç—è—Ç –∫—É—à–∞—Ç—å)
    bots.forEach(bot => {
        bot.update();
        bot.draw();
        
        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ —Å –±–æ—Ç–æ–º
        const dist = Math.hypot(player.x - bot.x, player.y - bot.y);
        if (dist < player.r + bot.r) {
            // –ö—Ç–æ –±–æ–ª—å—à–µ, —Ç–æ—Ç –∏ —Å—ä–µ–ª
            // –î–∞–µ–º —Ñ–æ—Ä—É 10%, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–µ—Ä—Ü–∞–Ω–∏—è
            if (player.r > bot.r * 1.1) {
                // –ò–≥—Ä–æ–∫ —Å—ä–µ–ª –±–æ—Ç–∞
                player.r += bot.r * 0.2;
                respawnBot(bot);
            } else if (bot.r > player.r * 1.1) {
                // 